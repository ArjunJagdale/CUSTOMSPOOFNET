<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Anti-Spoof</title>

<!-- ONNX Runtime -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

<!-- MediaPipe Face Detection -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>

<style>
body{font-family:Arial;text-align:center;padding:20px}
video{width:350px;height:350px;object-fit:cover;transform:scaleX(-1);border-radius:12px}
button{padding:10px 25px;margin-top:15px;font-weight:bold;border-radius:8px;border:none;background:#2563eb;color:white;cursor:pointer}
button:disabled{background:#94a3b8}
#result{margin-top:15px;font-size:20px;font-weight:bold}
.real{color:#16a34a}
.attack{color:#dc2626}
.idle{color:#64748b}
.processing{color:#2563eb}
</style>
</head>

<body>

<h2>Live Anti-Spoof Verification</h2>
<video id="video" autoplay playsinline muted></video>
<br>
<button id="startBtn" disabled>Loading...</button>
<p id="result" class="idle">Waiting for face...</p>

<canvas id="canvas" width="224" height="224" style="display:none;"></canvas>

<script>
let session;
let faceDetector;
let faceBox = null;
let facePresent = false;

let isRunning = false;
let logits = [];

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });
const btn = document.getElementById("startBtn");
const resultEl = document.getElementById("result");

async function init() {

  // Load ONNX model
  session = await ort.InferenceSession.create("3.onnx");

  // Start camera
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }
  });
  video.srcObject = stream;

  video.onloadeddata = () => {
    initFaceDetector();
    btn.disabled = false;
    btn.innerText = "Start Verification";
  };
}

function initFaceDetector() {

  faceDetector = new FaceDetection({
    locateFile: file =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`
  });

  faceDetector.setOptions({
    model: "short",
    minDetectionConfidence: 0.6
  });

  faceDetector.onResults(results => {
    if (results.detections.length > 0) {
      facePresent = true;
      faceBox = results.detections[0].boundingBox;
      if (!isRunning) {
        resultEl.className = "idle";
        resultEl.innerText = "Face detected";
      }
    } else {
      facePresent = false;
      faceBox = null;
      resultEl.className = "idle";
      resultEl.innerText = "Waiting for face...";
      if (isRunning) stopVerification();
    }
  });

  detectLoop();
}

async function detectLoop() {
  if (video.readyState >= 2) {
    await faceDetector.send({ image: video });
  }
  requestAnimationFrame(detectLoop);
}

function startVerification() {

  if (!facePresent) {
    resultEl.innerText = "No face detected";
    return;
  }

  isRunning = true;
  logits = [];
  btn.disabled = true;
  btn.innerText = "Verifying...";
  resultEl.className = "processing";
  resultEl.innerText = "Processing...";

  setTimeout(stopVerification, 3000);
  inferenceLoop();
}

function stopVerification() {
  isRunning = false;
  btn.disabled = false;
  btn.innerText = "Start Verification";
  computeResult();
}

async function inferenceLoop() {

  if (!isRunning || !facePresent) return;

  const vw = video.videoWidth;
  const vh = video.videoHeight;

  const x = (faceBox.xCenter - faceBox.width / 2) * vw;
  const y = (faceBox.yCenter - faceBox.height / 2) * vh;
  const w = faceBox.width * vw;
  const h = faceBox.height * vh;

  // compensate mirror
  const correctedX = vw - x - w;

  ctx.drawImage(video, correctedX, y, w, h, 0, 0, 224, 224);

  const img = ctx.getImageData(0, 0, 224, 224).data;
  const input = new Float32Array(1 * 3 * 224 * 224);

  const mean = [0.485, 0.456, 0.406];
  const std  = [0.229, 0.224, 0.225];

  for (let i = 0; i < 224 * 224; i++) {
    const r = img[i * 4] / 255;
    const g = img[i * 4 + 1] / 255;
    const b = img[i * 4 + 2] / 255;

    input[i] = (r - mean[0]) / std[0];
    input[i + 224*224] = (g - mean[1]) / std[1];
    input[i + 2*224*224] = (b - mean[2]) / std[2];
  }

  const tensor = new ort.Tensor("float32", input, [1,3,224,224]);
  const output = await session.run({ input: tensor });

  logits.push(output.output.data[0]);

  setTimeout(inferenceLoop, 100);
}

function computeResult() {

  if (logits.length === 0) {
    resultEl.className = "idle";
    resultEl.innerText = "No valid samples";
    return;
  }

  const avg = logits.reduce((a,b)=>a+b,0)/logits.length;
  const prob = 1/(1+Math.exp(-avg));

  const real = prob > 0.5;
  const confidence = real ? prob : 1 - prob;

  if (real) {
    resultEl.className = "real";
    resultEl.innerText = `REAL (${(confidence*100).toFixed(1)}%)`;
  } else {
    resultEl.className = "attack";
    resultEl.innerText = `SPOOF DETECTED (${(confidence*100).toFixed(1)}%)`;
  }
}

btn.addEventListener("click", startVerification);

init();
</script>

</body>
</html>
